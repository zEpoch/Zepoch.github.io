<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>how to run Spatial ID | zepoch's site</title><meta name="keywords" content="Spatial ID,genomics"><meta name="author" content="zepoch"><meta name="copyright" content="zepoch"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="before you start to run the program, you should make something installed. pip install torch torchvision torchaudio --index-url https:&#x2F;&#x2F;download.pytorch.org&#x2F;whl&#x2F;cpu pip install torch-cluster -f https">
<meta property="og:type" content="article">
<meta property="og:title" content="how to run Spatial ID">
<meta property="og:url" content="https://www.zepoch.cc/2023/3439187702.html">
<meta property="og:site_name" content="zepoch&#39;s site">
<meta property="og:description" content="before you start to run the program, you should make something installed. pip install torch torchvision torchaudio --index-url https:&#x2F;&#x2F;download.pytorch.org&#x2F;whl&#x2F;cpu pip install torch-cluster -f https">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2023-06-07T10:05:40.000Z">
<meta property="article:modified_time" content="2023-06-07T10:08:35.881Z">
<meta property="article:author" content="zepoch">
<meta property="article:tag" content="Spatial ID">
<meta property="article:tag" content="genomics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.zepoch.cc/2023/3439187702"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="AXddQAUftQD7NDjBUlQvw5LWu1x_A1uNpdVqI8c_3J0"/><meta name="baidu-site-verification" content="code-wVE0OwLLU2"/><meta name="bing_site_verification" content="154CD85FDB00EA195DB3F8F193CE78BE"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'how to run Spatial ID',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: false,
  postUpdate: '2023-06-07 18:08:35'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="zepoch's site" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zepoch's site</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">how to run Spatial ID</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-07T10:05:40.000Z" title="发表于 2023-06-07 18:05:40">2023-06-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-07T10:08:35.881Z" title="更新于 2023-06-07 18:08:35">2023-06-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">46k</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="how to run Spatial ID"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p>before you start to run the program, you should make something
installed.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
pip <span class="token function">install</span> torch-cluster -f https://pytorch-geometric.com/whl/torch-2.0.1+cpu.html
pip <span class="token function">install</span> torch-scatter -f https://pytorch-geometric.com/whl/torch-2.0.1+cpu.html
pip <span class="token function">install</span> torch-sparse -f https://pytorch-geometric.com/whl/torch-2.0.1+cpu.html
pip <span class="token function">install</span> torch-geometric<span class="token operator">==</span><span class="token number">2.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Before running, you need to copy the
<code>cell_type_annotation_model.pyc</code> file to the program running
directory. The first is the introduction of the package</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>sparse <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> random
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> anndata
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> scanpy <span class="token keyword">as</span> sc
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch_geometric
<span class="token keyword">from</span> cell_type_annotation_model <span class="token keyword">import</span> DNNModel<span class="token punctuation">,</span> SpatialModelTrainer
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> Data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Then there is the setting of random seed, so that the experimental
results can be repeated</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>manual_seed_all<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">False</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>deterministic <span class="token operator">=</span> <span class="token boolean">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Next is the reading of single cell data. It should be noted that the
homogenization of single cells needs to be consistent with the spatial
group. If the. X matrix of a single cell is the original counts matrix,
then the. X matrix of the spatial group should also be the original
matrix; If the. X matrix of a single cell is a matrix processed by log
normalization, then the. X matrix of a spatial group should also be a
matrix processed by log normalization, the same applies to other
matrices. I have already processed the single cell data and spatial
group data consistently in this note, so I will not elaborate on the
normalization steps here.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">adata <span class="token operator">=</span> sc<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'../single_cell/snrna_fetal_brain.h5ad'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Next is the training of the DNN model. We can see the process in the
first diagram of the Spatial ID original text. The first step is to
train a DNN model using one's own single cell data, and then proceed
with subsequent processing. The following is the training process of the
DNN model I wrote for your reference</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dnn_train</span><span class="token punctuation">(</span>adata<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> train_percent<span class="token punctuation">,</span> epoches<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> learning_rate<span class="token punctuation">,</span> model_save_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment">#### labels_transform</span>
    <span class="token keyword">def</span> <span class="token function">labels_transform</span><span class="token punctuation">(</span>raw_labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        raw_labels_copy <span class="token operator">=</span> raw_labels<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        labels_categroies <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">set</span><span class="token punctuation">(</span>raw_labels<span class="token punctuation">)</span><span class="token punctuation">]</span>
        length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>labels_categroies<span class="token punctuation">)</span>
        re_dic <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>
            raw_labels_copy<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>labels_categroies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> inplace <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
            re_dic<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> labels_categroies<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> raw_labels_copy<span class="token punctuation">]</span><span class="token punctuation">,</span>re_dic
    
    <span class="token comment">### save models</span>
    <span class="token keyword">def</span> <span class="token function">save_model</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n==> save model...&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token string">'model'</span><span class="token punctuation">:</span>DnnModel<span class="token punctuation">,</span>
            <span class="token string">'label_names'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>lable_dic<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> lable_dic<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'marker_genes'</span><span class="token punctuation">:</span>gene_names<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> model_save_path<span class="token operator">+</span> <span class="token string">'_'</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'.dnnmodel'</span><span class="token punctuation">)</span>
    
    
    <span class="token comment">###preprocess</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n==> Preprocessing...'</span><span class="token punctuation">)</span>
    adata_x <span class="token operator">=</span> adata<span class="token punctuation">.</span>X<span class="token punctuation">.</span>todense<span class="token punctuation">(</span><span class="token punctuation">)</span>
    raw_labels <span class="token operator">=</span> adata<span class="token punctuation">.</span>obs<span class="token punctuation">[</span>labels<span class="token punctuation">]</span>
    gene_names <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> adata<span class="token punctuation">.</span>var_names<span class="token punctuation">]</span>
    labels<span class="token punctuation">,</span> lable_dic <span class="token operator">=</span> labels_transform<span class="token punctuation">(</span>raw_labels<span class="token punctuation">)</span>
    inputs<span class="token punctuation">,</span> outputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>adata_x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">###dataloader</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n==> Predataloader...'</span><span class="token punctuation">)</span>
    dataset <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span>
    tran_legth<span class="token punctuation">,</span> test_length <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token operator">*</span>train_percent<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token operator">*</span>train_percent<span class="token punctuation">)</span>
    train_set<span class="token punctuation">,</span> test_set <span class="token operator">=</span> Data<span class="token punctuation">.</span>random_split<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token punctuation">[</span>tran_legth<span class="token punctuation">,</span> test_length<span class="token punctuation">]</span><span class="token punctuation">)</span>
    train_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_set<span class="token punctuation">,</span> 
                                   batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> 
                                   shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
    
    test_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>test_set<span class="token punctuation">,</span> 
                                  batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> 
                                  shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token comment">#####</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n==> DnnModel...'</span><span class="token punctuation">)</span>
    input_dim <span class="token operator">=</span> inputs<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    hidden_dim <span class="token operator">=</span> hidden_dim
    output_dim <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">)</span>
    learning_rate <span class="token operator">=</span> learning_rate
    
    DnnModel <span class="token operator">=</span> DNNModel<span class="token punctuation">(</span>input_dim <span class="token operator">=</span> input_dim<span class="token punctuation">,</span> 
                    hidden_dim <span class="token operator">=</span> hidden_dim<span class="token punctuation">,</span> 
                    output_dim <span class="token operator">=</span> output_dim<span class="token punctuation">,</span>
                    drop_rate<span class="token operator">=</span><span class="token number">0.2</span>
                       <span class="token punctuation">)</span>
    <span class="token comment">###train</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n==> train...'</span><span class="token punctuation">)</span>
    counts <span class="token operator">=</span> <span class="token number">0</span>
    max_acc <span class="token operator">=</span> <span class="token number">0</span>
    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>DnnModel<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr <span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epoches<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> input_tensor<span class="token punctuation">,</span>transformed_labels <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>
            out <span class="token operator">=</span> DnnModel<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>out<span class="token punctuation">,</span> transformed_labels<span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> 
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        correct <span class="token operator">=</span> <span class="token number">0</span>
        total <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
            <span class="token keyword">for</span> input_tensor<span class="token punctuation">,</span>transformed_labels <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>
                pred <span class="token operator">=</span> DnnModel<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                
                correct <span class="token operator">+=</span> <span class="token punctuation">(</span>pred <span class="token operator">==</span> transformed_labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                total <span class="token operator">+=</span> transformed_labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        acc <span class="token operator">=</span> correct <span class="token operator">/</span> total
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[epoch &#123;&#125;], loss: &#123;&#125;, acc：&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>data<span class="token punctuation">,</span> correct <span class="token operator">/</span> total<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>acc <span class="token operator">></span> max_acc<span class="token punctuation">)</span><span class="token punctuation">:</span>
            max_acc <span class="token operator">=</span> acc
            save_model<span class="token punctuation">(</span>counts<span class="token punctuation">)</span>
            counts <span class="token operator">+=</span> <span class="token number">1</span>
    
    save_model<span class="token punctuation">(</span>counts<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Label is the single cell annotation in your OBS, train_percentage is
the percentage of data you use for training, epochs is the number of
training sessions, learning_ Rate is the learning rate of training,
which depends on one's own tuning; model_save_path is the storage
location for the DNN model that I have trained myself. I have set an
accuracy parameter here, and an increase in acc will automatically save
this model. Finally, a model will also be saved. It is recommended to
train the acc for this step to over 80%. If the acc is too low, it
indicates that there may be a problem with single cell annotation.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">dnn_train<span class="token punctuation">(</span>adata<span class="token punctuation">,</span> 
          labels <span class="token operator">=</span> <span class="token string">'label'</span><span class="token punctuation">,</span> 
          hidden_dim <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">,</span> 
          train_percent <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">,</span> 
          epoches <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> 
          batch_size <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span> 
          learning_rate <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">,</span> 
          model_save_path <span class="token operator">=</span> <span class="token string">'./dnnmodel/model'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Next comes the other steps in the Spatial ID paper, besides the DNN
model training, which is the transfer process. The code is as
follows</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">transfer</span><span class="token punctuation">(</span>adata<span class="token punctuation">,</span> model<span class="token punctuation">,</span> transfer_batchsize<span class="token punctuation">,</span> result_csv<span class="token punctuation">,</span> new_adata<span class="token punctuation">,</span> device<span class="token punctuation">,</span>k_graph<span class="token punctuation">,</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># Load DNN model trained by sc-dataset.</span>
    checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    dnn_model <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token comment"># Initialize DNN input.</span>
    marker_genes <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">'marker_genes'</span><span class="token punctuation">]</span>
    gene_indices <span class="token operator">=</span> adata<span class="token punctuation">.</span>var_names<span class="token punctuation">.</span>get_indexer<span class="token punctuation">(</span>marker_genes<span class="token punctuation">)</span>
    adata_X <span class="token operator">=</span> np<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>adata<span class="token punctuation">.</span>X<span class="token punctuation">.</span>todense<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> gene_indices<span class="token punctuation">]</span>
    norm_factor <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>adata_X<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    norm_factor<span class="token punctuation">[</span>norm_factor <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
    dnn_inputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>adata_X <span class="token operator">/</span> norm_factor<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>transfer_batchsize<span class="token punctuation">)</span>
    
    <span class="token comment"># Inference with DNN model.</span>
    dnn_predictions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> inputs <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dnn_inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            outputs <span class="token operator">=</span> dnn_model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
            dnn_predictions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    label_names <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">'label_names'</span><span class="token punctuation">]</span>
    adata<span class="token punctuation">.</span>obsm<span class="token punctuation">[</span><span class="token string">'pseudo_label'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>dnn_predictions<span class="token punctuation">)</span>
    adata<span class="token punctuation">.</span>obs<span class="token punctuation">[</span><span class="token string">'pseudo_class'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>Categorical<span class="token punctuation">(</span><span class="token punctuation">[</span>label_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> adata<span class="token punctuation">.</span>obsm<span class="token punctuation">[</span><span class="token string">'pseudo_label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    adata<span class="token punctuation">.</span>uns<span class="token punctuation">[</span><span class="token string">'pseudo_classes'</span><span class="token punctuation">]</span> <span class="token operator">=</span> label_names
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>adata<span class="token punctuation">.</span>obs<span class="token punctuation">[</span><span class="token string">'pseudo_class'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Construct spatial graph.</span>
    gene_mat <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>adata_X<span class="token punctuation">)</span>
    cell_coo <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>adata<span class="token punctuation">.</span>obsm<span class="token punctuation">[</span><span class="token string">'spatial'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> torch_geometric<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Data<span class="token punctuation">(</span>x <span class="token operator">=</span> gene_mat<span class="token punctuation">,</span> pos <span class="token operator">=</span> cell_coo<span class="token punctuation">)</span>
    data <span class="token operator">=</span> torch_geometric<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>KNNGraph<span class="token punctuation">(</span>k <span class="token operator">=</span> k_graph<span class="token punctuation">,</span> loop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    data<span class="token punctuation">.</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>adata<span class="token punctuation">.</span>obsm<span class="token punctuation">[</span><span class="token string">'pseudo_label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># Make distances as edge weights.</span>
    data <span class="token operator">=</span> torch_geometric<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Distance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    data<span class="token punctuation">.</span>edge_weight <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> data<span class="token punctuation">.</span>edge_attr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    
    <span class="token comment"># Train self-supervision model.</span>
    params <span class="token operator">=</span> params
    input_dim <span class="token operator">=</span> data<span class="token punctuation">.</span>num_features
    num_classes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>adata<span class="token punctuation">.</span>uns<span class="token punctuation">[</span><span class="token string">'pseudo_classes'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    trainer <span class="token operator">=</span> SpatialModelTrainer<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> 
                                  num_classes<span class="token punctuation">,</span> 
                                  device<span class="token punctuation">,</span> 
                                  params <span class="token operator">=</span> params<span class="token punctuation">)</span>
    trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span>data<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token comment"># trainer.save_checkpoint()</span>
    
    <span class="token comment"># Inference.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n==> Inferencing...'</span><span class="token punctuation">)</span>
    predictions <span class="token operator">=</span> trainer<span class="token punctuation">.</span>valid<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    celltype_pred <span class="token operator">=</span> pd<span class="token punctuation">.</span>Categorical<span class="token punctuation">(</span><span class="token punctuation">[</span>adata<span class="token punctuation">.</span>uns<span class="token punctuation">[</span><span class="token string">'pseudo_classes'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> predictions<span class="token punctuation">]</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'cell'</span><span class="token punctuation">:</span> adata<span class="token punctuation">.</span>obs_names<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'celltype_pred'</span><span class="token punctuation">:</span> celltype_pred<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>result_csv<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    adata<span class="token punctuation">.</span>obsm<span class="token punctuation">[</span><span class="token string">'celltype_prob'</span><span class="token punctuation">]</span> <span class="token operator">=</span> predictions
    adata<span class="token punctuation">.</span>obs<span class="token punctuation">[</span><span class="token string">'celltype_pred'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>Categorical<span class="token punctuation">(</span>celltype_pred<span class="token punctuation">)</span>
    adata<span class="token punctuation">.</span>write<span class="token punctuation">(</span>new_adata<span class="token punctuation">)</span>    
    sc<span class="token punctuation">.</span>pl<span class="token punctuation">.</span>spatial<span class="token punctuation">(</span>adata<span class="token punctuation">,</span> img_key<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'celltype_pred'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> palette  <span class="token operator">=</span>  <span class="token string">'gnuplot2'</span><span class="token punctuation">,</span> spot_size<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The above is the definition of the function, and the following are
the parameters and corresponding operations. Fill in the DNN model you
trained above with the model, result_csv stores the cell type data
corresponding to each bin/cell, new_ Adata is the data annotated with
cells, and params is the parameter that needs to be adjusted. You need
to debug it yourself based on the situation of the transfer.</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#Read in spatial group data</span>

spatial_adata <span class="token operator">=</span> sc<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'../spatial/A5.h5ad'</span><span class="token punctuation">)</span>
params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">'pca_dim'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>  
    <span class="token string">'k_graph'</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token string">'edge_weight'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">'kd_T'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token string">'feat_dim'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token string">'w_dae'</span><span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
    <span class="token string">'w_gae'</span><span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">,</span>
    <span class="token string">'w_cls'</span><span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>
    <span class="token string">'epochs'</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token string">'lr'</span><span class="token punctuation">:</span> <span class="token number">0.0005</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

transfer<span class="token punctuation">(</span>spatial_adata<span class="token punctuation">,</span> 
         model <span class="token operator">=</span> <span class="token string">'test___11.dnnmodel'</span><span class="token punctuation">,</span> 
         transfer_batchsize <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">,</span> 
         result_csv <span class="token operator">=</span> <span class="token string">'test_10.csv'</span><span class="token punctuation">,</span> 
         new_adata <span class="token operator">=</span><span class="token string">'new_10.h5ad'</span><span class="token punctuation">,</span> 
         device <span class="token operator">=</span> <span class="token string">'cpu'</span><span class="token punctuation">,</span>
         k_graph <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>
         params <span class="token operator">=</span> params<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zepoch</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.zepoch.cc/2023/3439187702.html">https://www.zepoch.cc/2023/3439187702.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.zepoch.cc" target="_blank">zepoch's site</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spatial-ID/">Spatial ID</a><a class="post-meta__tags" href="/tags/genomics/">genomics</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/2333370760.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">如何在stomics平台使用spateo圈细胞</div></div></a></div><div class="next-post pull-right"><a href="/2023/3539500839.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">如何将rds转为h5ad</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zepoch</div><div class="author-info__description">一个每天进步的全栈工程师，记录我的工作学习与生活</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zepoch"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zepoch" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhotoa@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/2709315503.html" title="使用GTF和fasta生成每个geneid对应最长的fasta序列">使用GTF和fasta生成每个geneid对应最长的fasta序列</a><time datetime="2023-11-02T08:04:08.000Z" title="发表于 2023-11-02 16:04:08">2023-11-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/2375055875.html" title="杂聊8">杂聊8</a><time datetime="2023-10-29T14:27:06.000Z" title="发表于 2023-10-29 22:27:06">2023-10-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/2146294005.html" title="scanpy多张图绘制于一张">scanpy多张图绘制于一张</a><time datetime="2023-10-18T15:29:55.000Z" title="发表于 2023-10-18 23:29:55">2023-10-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/2239161542.html" title="杂聊7">杂聊7</a><time datetime="2023-09-10T13:19:56.000Z" title="发表于 2023-09-10 21:19:56">2023-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/394364691.html" title="使用空间转录组文件gem生成相应的灰度图">使用空间转录组文件gem生成相应的灰度图</a><time datetime="2023-07-27T11:01:01.000Z" title="发表于 2023-07-27 19:01:01">2023-07-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By zepoch</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'WspkUq7TuRDz5tk68Ry6TSa1-gzGzoHsz',
      appKey: 'xz4SYcXtJNP1hns8iBFAlhHT',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>
            window.imageLazyLoadSetting = {
                isSPA: true,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>