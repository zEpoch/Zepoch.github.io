<!DOCTYPE html><html lang="en-US" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>空间组deg genemodule heatmap go分析 | zepoch's site</title><meta name="author" content="zepoch"><meta name="copyright" content="zepoch"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="空间转录组通过手动划区注释之后，得到空间组的区域注释信息，这个时候我们便是想要得到其差异表达基因的功能注释信息，这里并没有能够通用的脚本，本人仅是提供一种思路，供大家参考。 由于我们的空间组的数据大都是 anndata 的 h5ad 的文件格式，所以我们需要将其转换为能够被 seurat 读取的 rds 文件格式，这里采用我们之前博客讲到的一个便捷工具 rds与h5ad的相互转换，大概代码如">
<meta property="og:type" content="article">
<meta property="og:title" content="空间组deg genemodule heatmap go分析">
<meta property="og:url" content="https://www.zepoch.cc/2024/397295361.html">
<meta property="og:site_name" content="zepoch&#39;s site">
<meta property="og:description" content="空间转录组通过手动划区注释之后，得到空间组的区域注释信息，这个时候我们便是想要得到其差异表达基因的功能注释信息，这里并没有能够通用的脚本，本人仅是提供一种思路，供大家参考。 由于我们的空间组的数据大都是 anndata 的 h5ad 的文件格式，所以我们需要将其转换为能够被 seurat 读取的 rds 文件格式，这里采用我们之前博客讲到的一个便捷工具 rds与h5ad的相互转换，大概代码如">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.zepoch.cc/img/avatar.jpg">
<meta property="article:published_time" content="2024-01-03T02:19:37.000Z">
<meta property="article:modified_time" content="2024-01-03T02:59:38.962Z">
<meta property="article:author" content="zepoch">
<meta property="article:tag" content="tech">
<meta property="article:tag" content="技术">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.zepoch.cc/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.zepoch.cc/2024/397295361.html"><link rel="preconnect"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="AXddQAUftQD7NDjBUlQvw5LWu1x_A1uNpdVqI8c_3J0"/><meta name="baidu-site-verification" content="code-wVE0OwLLU2"/><meta name="bing_site_verification" content="154CD85FDB00EA195DB3F8F193CE78BE"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css?v=6.5.1"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css?v=5.0.32" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":6,"unescape":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js?v=4.11.0',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '空间组deg genemodule heatmap go分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: false,
  postUpdate: '2024-01-03 10:59:38'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="zepoch's site" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="zepoch's site"><span class="site-name">zepoch's site</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">空间组deg genemodule heatmap go分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2024-01-03T02:19:37.000Z" title="Created 2024-01-03 10:19:37">2024-01-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/tech/">tech</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/tech/%E6%8A%80%E6%9C%AF/">技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">4.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>20mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="空间组deg genemodule heatmap go分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><p>空间转录组通过手动划区注释之后，得到空间组的区域注释信息，这个时候我们便是想要得到其差异表达基因的功能注释信息，这里并没有能够通用的脚本，本人仅是提供一种思路，供大家参考。</p>
<p>由于我们的空间组的数据大都是 anndata 的 h5ad
的文件格式，所以我们需要将其转换为能够被 seurat 读取的 rds
文件格式，这里采用我们之前博客讲到的一个便捷工具 <a
href="https://www.zepoch.cc/2023/581620572.html">rds与h5ad的相互转换</a>，大概代码如下所述：</p>
<pre class="line-numbers language-R" data-language="R"><code class="language-R">sceasy::convertFormat(&#39;&#x2F;data&#x2F;*.h5ad&#39;, 
                      from&#x3D;&quot;anndata&quot;, 
                      to&#x3D;&quot;seurat&quot;, 
                      main_layer &#x3D; &#39;count&#39;,
                      outFile&#x3D;&#39;&#x2F;data&#x2F;*.rds&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>于是便是得到了相应的 rds 文件，之后我们借助 seurat 中的
findallmarkers
函数，来进行差异表达基因的筛选，并且去除一些我们不需要的基因，例如线粒体基因，核糖体蛋白基因，血红蛋白基因，细胞质基因，胶原蛋白基因等等，这里我们可以通过正则表达式来进行筛选，以及对
avglog2fc 进行排序，筛选出每个类群的前 50 个差异表达基因，之后对其进行
genemodule 的计算。这里需要注意的是，我在进行 deg
的计算的时候，并没有对空间组的数据进行归一化，因为我是bin50的数据，当然也不是不能进行归一化，这个大家可以自行决定是否要进行归一化；此外在计算
genemodule 的地方，我则是选取了选取了 raw 矩阵和均一化之后的矩阵都进行了
genemodule 的计算，大家可以出现的结果决定是否要进行归一化，虽然
addgenemodule 的文档上写了输入的矩阵是归一化的矩阵。</p>
<p>脚本里面还有一些看着比较奇怪的代码，输入计算 deg 的矩阵和计算
genemodule
的矩阵可以是不一样的，原因在于我们可能空间组芯片上某些位置的捕获与其他地方不一样，需要我们去除掉，这个时候我们可以选取
<code>去除了某些区域的矩阵</code> 去计算 deg，之后再用正常的芯片去计算
genemodule。</p>
<pre class="line-numbers language-R" data-language="R"><code class="language-R"># Rscript your_script.R path_to_rds_file.rds refined_pred_column_name path_to_output_csv_file.csv

# 读取命令行参数
args &lt;- commandArgs(trailingOnly &#x3D; TRUE)

# 检查是否提供了正确的参数数量
if (length(args) !&#x3D; 4) &#123;
  stop(&quot;需要提供三个参数：rds_deg_path, rds_module_path, refined_pred, def_save_path&quot;)
&#125;

# 解析命令行参数
rds_deg_path &lt;- args[1]
rds_module_path &lt;- args[2]
cluster &lt;- args[3]
save_path &lt;- args[4]

# 导入所需的库
library(Seurat)
library(tidyverse)

# 读取单细胞数据
rds &lt;- readRDS(rds_deg_path)

# 设置 rds 对象的细胞类型标签
Idents(rds) &lt;- rds@meta.data[[cluster]]

# 查找差异表达基因
df &lt;- FindAllMarkers(rds, only.pos &#x3D; TRUE)

# 去除以 MT|HB|RP|AC|COL 开头的基因
# MT 线粒体
# RP 核糖体蛋白
# HB 血红蛋白
# AC 细胞质
# COL 胶原蛋白
deg_save_path &#x3D; paste(save_path,&#39;deg&#x2F;deg.csv&#39;, sep &#x3D; &#39;&#39;)
write_csv(df, deg_save_path)

filtered_df &lt;- df[!grepl(&quot;^(MT|HB|RP|AC|COL)&quot;, df$gene), ]

# 创建一个以 cluster 为索引的列表，每个 cluster 对应一个子数据框
cluster_list &lt;- split(filtered_df, filtered_df$cluster)
sort_and_select &lt;- function(df) &#123;
  sorted_df &lt;- df[order(df$avg_log2FC, decreasing &#x3D; TRUE), ]
  return(sorted_df)
&#125;

# 对每个子数据框应用排序和筛选函数
sorted_dfs &lt;- lapply(cluster_list, sort_and_select)

# 合并所有排序后的子数据框为一个新的数据框
filtered_df &lt;- do.call(rbind, sorted_dfs)

deg_save_path &#x3D; paste(save_path,&#39;deg&#x2F;filtered_deg.csv&#39;, sep &#x3D; &#39;&#39;)
write_csv(filtered_df, deg_save_path)

# 创建一个以 cluster 为索引的列表，每个 cluster 对应一个子数据框
cluster_list &lt;- split(filtered_df, filtered_df$cluster)

# 定义一个函数，用于对子数据框按照 avglog2fc 列进行排序，并筛选前 50 行
sort_and_select &lt;- function(df) &#123;
  sorted_df &lt;- df[order(df$avg_log2FC, decreasing &#x3D; TRUE), ]
  if (nrow(sorted_df) &gt;&#x3D; 50) &#123;
    return(sorted_df[1:50, ])
  &#125; else &#123;
    return(sorted_df)
  &#125;
&#125;

# 对每个子数据框应用排序和筛选函数
sorted_dfs &lt;- lapply(cluster_list, sort_and_select)

# 合并所有排序后的子数据框为一个新的数据框
new_dataframe &lt;- do.call(rbind, sorted_dfs)

# 输出最终结果
# print(new_dataframe)
deg_save_path &#x3D; paste(save_path,&#39;deg&#x2F;filtered_top50_deg.csv&#39;, sep &#x3D; &#39;&#39;)
write_csv(new_dataframe, deg_save_path)

# 将 cluster 列中的唯一值保存到 unique_cluster 中
unique_cluster &lt;- unique(new_dataframe$cluster)
# 对每个唯一的 cluster 值进行循环操作
for (cluster_value in unique_cluster) &#123;
    # 这里执行你的操作，例如：
    # 通过 subset 函数筛选出特定 cluster 值的行
    print(cluster_value)
    subset_df &lt;- subset(filtered_df, cluster &#x3D;&#x3D; cluster_value)
    gene_list &lt;- subset_df$gene
    gene_list &#x3D; list(gene_list)
    gene_modules &#x3D; paste(cluster_value ,&#39;_module&#39;, sep &#x3D; &#39;&#39;)
    rds &lt;- readRDS(rds_module_path)
    rds &#x3D; AddModuleScore(rds, features&#x3D;gene_list,name&#x3D;&#39;gene_modules&#39;, nbin &#x3D; 12)
    gene_module_path &#x3D; paste(save_path, &#39;genemodules&#x2F;csv&#x2F;&#39;,cluster_value, &#39;_raw_genemodule.csv&#39;, sep &#x3D; &quot;&quot;)
    write.csv(rds@meta.data, gene_module_path)

    rds &#x3D; NormalizeData(rds)
    rds &#x3D; AddModuleScore(rds, features&#x3D;gene_list,name&#x3D;&#39;gene_modules&#39;, nbin &#x3D; 12)
    
    gene_module_path &#x3D; paste(save_path, &#39;genemodules&#x2F;csv&#x2F;&#39;,cluster_value, &#39;_lognor_genemodule.csv&#39;, sep &#x3D; &quot;&quot;)
    
    write.csv(rds@meta.data, gene_module_path)

    # 打印子集数据框的摘要信息    
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>计算了 genemodule
的信息之后，便是需要对其在空间组上进行绘制，看看这些计算出的 deg
是否在我们划分的区域富集，这里采用了 scanpy ，采用scanpy的原因在于
scanpy 的 spatial 绘图函数较为通用以及便捷。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># python your_script.py --adata_file_path path_to_adata_file --csv_file_path path_to_csv_file --gene_modules module_name</span>

<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> scanpy <span class="token keyword">as</span> sc
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> os
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> scanpy <span class="token keyword">as</span> sc

<span class="token comment"># 创建参数解析器</span>
parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 添加命令行选项</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--adata_file_path'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Path to the AnnData file'</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save_path'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Name of the gene module column'</span><span class="token punctuation">)</span>

<span class="token comment"># 解析命令行参数</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 将参数值赋给对应的变量</span>
adata_file_path <span class="token operator">=</span> args<span class="token punctuation">.</span>adata_file_path
save_path <span class="token operator">=</span> args<span class="token punctuation">.</span>save_path

adata <span class="token operator">=</span> sc<span class="token punctuation">.</span>read<span class="token punctuation">(</span>adata_file_path<span class="token punctuation">)</span>

csv_path_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>save_path<span class="token operator">+</span><span class="token string">'genemodules/csv'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>csv_path_dir<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> csv_path_dir<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'genemodule'</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        name <span class="token operator">=</span> i<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.csv'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        gene_modules <span class="token operator">=</span> <span class="token string">'gene_modules1'</span> 

        csv <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span><span class="token string">'genemodules/csv/'</span><span class="token operator">+</span> i<span class="token punctuation">)</span>
        gene_modules <span class="token operator">=</span> csv<span class="token punctuation">[</span>gene_modules<span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

        adata<span class="token punctuation">.</span>obs<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> gene_modules
        sc<span class="token punctuation">.</span>pl<span class="token punctuation">.</span>spatial<span class="token punctuation">(</span>adata<span class="token punctuation">,</span> color <span class="token operator">=</span> name<span class="token punctuation">,</span> spot_size <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> show <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> frameon <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'genemodules/fig/'</span><span class="token operator">+</span>i<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.csv'</span><span class="token punctuation">,</span> <span class="token string">'.pdf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'genemodule plot over!'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到此为止，deg计算完毕，genemodule 计算完毕，绘制完毕。接下来进行
heatmap 的绘制，这里是用的 python 进行计算，R
语言进行绘图，我们将每个区域视为一个 psudo
bulk，对于每个基因，计算其在每个 psudo bulk 中的平均表达量，然后保存为
csv，之后采用 R 语言进行绘制。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> anndata <span class="token keyword">as</span> ad
<span class="token keyword">import</span> os
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> scanpy <span class="token keyword">as</span> sc
<span class="token comment"># 创建参数解析器</span>
parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 添加命令行选项</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--adata_file_path'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Path to the AnnData file'</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save_path'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Name of the gene module column'</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cluster'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Name of the cluster column'</span><span class="token punctuation">)</span>

<span class="token comment"># 解析命令行参数</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 将参数值赋给对应的变量</span>
adata_file_path <span class="token operator">=</span> args<span class="token punctuation">.</span>adata_file_path
save_path <span class="token operator">=</span> args<span class="token punctuation">.</span>save_path
cluster <span class="token operator">=</span> args<span class="token punctuation">.</span>cluster

listdir <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'deg/'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>listdir<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> listdir<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'filtered'</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>
        adata <span class="token operator">=</span> ad<span class="token punctuation">.</span>read<span class="token punctuation">(</span>adata_file_path<span class="token punctuation">)</span>
        name <span class="token operator">=</span> i<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.csv'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        csv <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'deg/'</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
        deg_df_cluster <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>csv<span class="token punctuation">[</span><span class="token string">'cluster'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        all_genes_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> deg_df_cluster<span class="token punctuation">:</span>
            temp <span class="token operator">=</span> csv<span class="token punctuation">[</span>csv<span class="token punctuation">[</span><span class="token string">'cluster'</span><span class="token punctuation">]</span> <span class="token operator">==</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">'avg_log2FC'</span><span class="token punctuation">,</span> ascending <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gene<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
            all_genes_ <span class="token operator">+=</span> temp
        all_genes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token keyword">for</span> j <span class="token keyword">in</span> all_genes_<span class="token punctuation">:</span>
            <span class="token keyword">if</span> j <span class="token keyword">in</span> all_genes<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                all_genes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>j<span class="token punctuation">)</span>
        heatmap <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index <span class="token operator">=</span> all_genes<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> deg_df_cluster<span class="token punctuation">:</span>
            
            adata_temp <span class="token operator">=</span> adata<span class="token punctuation">[</span>adata<span class="token punctuation">.</span>obs<span class="token punctuation">[</span>cluster<span class="token punctuation">]</span> <span class="token operator">==</span> j<span class="token punctuation">]</span>
            adata_temp <span class="token operator">=</span> adata_temp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>all_genes<span class="token punctuation">]</span><span class="token punctuation">.</span>X<span class="token punctuation">.</span>todense<span class="token punctuation">(</span><span class="token punctuation">)</span>
            adata_temp <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>adata_temp<span class="token punctuation">,</span>columns <span class="token operator">=</span> all_genes<span class="token punctuation">)</span>
            heatmap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> adata_temp<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
        heatmap<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'heatmap/'</span> <span class="token operator">+</span> name <span class="token operator">+</span><span class="token string">'_raw_heatmap.csv'</span><span class="token punctuation">)</span>
        
        sc<span class="token punctuation">.</span>pp<span class="token punctuation">.</span>normalize_total<span class="token punctuation">(</span>adata<span class="token punctuation">,</span> target_sum<span class="token operator">=</span><span class="token number">1e4</span><span class="token punctuation">)</span>
        sc<span class="token punctuation">.</span>pp<span class="token punctuation">.</span>log1p<span class="token punctuation">(</span>adata<span class="token punctuation">)</span>
        adata <span class="token operator">=</span> adata<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>all_genes<span class="token punctuation">]</span>
        sc<span class="token punctuation">.</span>pp<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>adata<span class="token punctuation">,</span> max_value<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        
        heatmap <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index <span class="token operator">=</span> all_genes<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> deg_df_cluster<span class="token punctuation">:</span>
            
            adata_temp <span class="token operator">=</span> adata<span class="token punctuation">[</span>adata<span class="token punctuation">.</span>obs<span class="token punctuation">[</span>cluster<span class="token punctuation">]</span> <span class="token operator">==</span> j<span class="token punctuation">]</span>
            <span class="token comment"># print(adata_temp.X)</span>
            adata_temp <span class="token operator">=</span> adata_temp<span class="token punctuation">.</span>X
            adata_temp <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>adata_temp<span class="token punctuation">,</span>columns <span class="token operator">=</span> all_genes<span class="token punctuation">)</span>
            heatmap<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> adata_temp<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
        heatmap<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'heatmap/'</span> <span class="token operator">+</span> name <span class="token operator">+</span><span class="token string">'_lognor_heatmap.csv'</span><span class="token punctuation">)</span>
        
        
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>绘制函数如下所示：</p>
<pre class="line-numbers language-R" data-language="R"><code class="language-R"># Rscript 1.R gene_list_value rds_path_value gene_modules_value gene_module_path_value gene_module_normalized_path_value

# 读取命令行参数
args &lt;- commandArgs(trailingOnly &#x3D; TRUE)

# 检查是否提供了正确的参数数量
if (length(args) !&#x3D; 1) &#123;
  stop(&quot;需要提供一个参数：save_path&quot;)
&#125;

# 解析命令行参数
save_path &#x3D; args[1]

library(pheatmap)
library(ggplot2)
library(viridis)
library(tidyverse)

raw &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_deg_raw_heatmap.csv&#39;, sep &#x3D; &#39;&#39;)

data &lt;- read.csv(raw, encoding&#x3D;&quot;UTF-8&quot;)
rownames(data) &#x3D; data$X
data$X &#x3D;NULL
mycolors &#x3D; viridis(11)

options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_deg_raw_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)


options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,scale &#x3D; &quot;row&quot;,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_deg_raw_scale_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)


raw &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_deg_lognor_heatmap.csv&#39;, sep &#x3D; &#39;&#39;)

data &lt;- read.csv(raw, encoding&#x3D;&quot;UTF-8&quot;)
rownames(data) &#x3D; data$X
data$X &#x3D;NULL
mycolors &#x3D; viridis(11)

options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_deg_lognor_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)


options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,scale &#x3D; &quot;row&quot;,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_deg_lognor_scale_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)


raw &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_top50_deg_raw_heatmap.csv&#39;, sep &#x3D; &#39;&#39;)

data &lt;- read.csv(raw, encoding&#x3D;&quot;UTF-8&quot;)
rownames(data) &#x3D; data$X
data$X &#x3D;NULL
mycolors &#x3D; viridis(11)

options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_top50_deg_raw_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)


options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,scale &#x3D; &quot;row&quot;,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_top50_deg_raw_scale_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)


raw &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_top50_deg_lognor_heatmap.csv&#39;, sep &#x3D; &#39;&#39;)

data &lt;- read.csv(raw, encoding&#x3D;&quot;UTF-8&quot;)
rownames(data) &#x3D; data$X
data$X &#x3D;NULL
mycolors &#x3D; viridis(11)

options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_top50_deg_lognor_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)


options(repr.plot.width&#x3D;6, repr.plot.height&#x3D;20)
p &#x3D; pheatmap(data ,cluster_col &#x3D; FALSE,cluster_row &#x3D; FALSE,scale &#x3D; &quot;row&quot;,color &#x3D; colorRampPalette(mycolors)(100),)

raw_save_path &#x3D; paste(save_path, &#39;heatmap&#x2F;filtered_top50_deg_lognor_scale_heatmap.pdf&#39;, sep &#x3D; &#39;&#39;)
ggsave(raw_save_path, plot &#x3D; p, width&#x3D;6,height&#x3D;20,limitsize &#x3D; FALSE)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>R
函数的heatmap绘制了不止一个图，而且多个，大家可以自行选择需要的。最后是进行
GO 富集分析，这里我采用了 clusterProfiler 进行 GO
富集分析，这里的代码也是比较简单的，大家可以自行参考。</p>
<pre class="line-numbers language-R" data-language="R"><code class="language-R"># Rscript your_script.R path_to_rds_file.rds refined_pred_column_name path_to_output_csv_file.csv

# 读取命令行参数
args &lt;- commandArgs(trailingOnly &#x3D; TRUE)

# 检查是否提供了正确的参数数量
if (length(args) !&#x3D; 1) &#123;
  stop(&quot;需要提供三个参数：save_path&quot;)
&#125;

# 解析命令行参数
save_path &lt;- args[1]

###---------------------go分析
library(&quot;clusterProfiler&quot;)
#install.packages(&quot;BiocManager&quot;)
#BiocManager::install(&quot;clusterProfiler&quot;)
#BiocManager::install(&quot;org.Hs.eg.db&quot;)
library(org.Hs.eg.db)
library(DOSE)
library(enrichplot)
library(&quot;tidyverse&quot;)
#install.packages(&quot;tidyverse&quot;)
library(RColorBrewer)
library(tidyverse)


#### go
cal_go &#x3D; function(genelist, fig_name, csv_name) &#123;
  go &#x3D; enrichGO(genelist, 
                OrgDb &#x3D; org.Hs.eg.db,
                ont &#x3D; &#39;ALL&#39;,
                pAdjustMethod &#x3D; &quot;BH&quot;,
                pvalueCutoff &#x3D; 1,
                qvalueCutoff &#x3D; 1,
                keyType &#x3D; &quot;SYMBOL&quot;)
  go.count &#x3D; data.frame(go)
  go.count_sort &#x3D; go.count[order(go.count$pvalue, decreasing &#x3D; FALSE),]
  
  top10 &#x3D; function(i) &#123;
    k &#x3D; head(i[order(i$pvalue), ], 10);
    return(k)
  &#125;
  
  dp &#x3D; rbind(top10(go.count[go.count[&#39;ONTOLOGY&#39;] &#x3D;&#x3D; &quot;BP&quot;, ]),
             top10(go.count[go.count[&#39;ONTOLOGY&#39;] &#x3D;&#x3D; &quot;CC&quot;, ]),
             top10(go.count[go.count[&#39;ONTOLOGY&#39;] &#x3D;&#x3D; &quot;MF&quot;, ]))
  d1 &#x3D; dp[which(dp[, 1] &#x3D;&#x3D; &quot;BP&quot;), ]
  d2 &#x3D; dp[which(dp[, 1] &#x3D;&#x3D; &quot;CC&quot;), ]
  d3 &#x3D; dp[which(dp[, 1] &#x3D;&#x3D; &quot;MF&quot;), ]
  
  d_l &#x3D; rbind(d1, d2, d3)
  
  mt &#x3D; d_l[, c(1, 3, 10)]
  
  colnames(mt)&lt;-c(&quot;Type&quot;,&quot;name&quot;,&quot;number&quot;)
  mt$name &lt;- factor(mt$name, levels &#x3D; rev(mt$name))
  
  ggplot(data&#x3D;mt, aes(x&#x3D;name,y&#x3D;number,fill&#x3D;Type))+ theme_bw()+
    geom_bar(stat &#x3D; &quot;identity&quot;, position&#x3D;position_dodge())+coord_flip()+xlab(&quot;GO term&quot;) + ylab(&quot;Number of genes&quot;)+
    scale_fill_brewer(palette&#x3D;&quot;Set2&quot;)+
    theme(panel.border &#x3D; element_blank(),
          plot.title &#x3D; element_text(face &#x3D; &quot;bold&quot;,size &#x3D; 12,vjust &#x3D;1),
          axis.title &#x3D; element_text(face &#x3D; &quot;bold&quot;,size &#x3D; 12, vjust &#x3D; 0.3),
          axis.text &#x3D; element_text(size &#x3D; 8, vjust &#x3D; 0.8), 
          axis.line &#x3D; element_line(), 
          panel.grid &#x3D; element_blank(),
          legend.position&#x3D;c(0.8,0.75),
          legend.key.size &#x3D; unit(4, &quot;mm&quot;))
  ggsave(fig_name, height &#x3D; 5, width &#x3D; 10)
  #write.csv(go.count_sort, csv_name, row.names &#x3D; F, quote &#x3D; F)
  go.count_sort %&gt;% write_csv(csv_name)
&#125;

# cluster &#x3D; paste(&#39;cluster&#39;, &#39;&#39;, )

dataframe_path &#x3D; paste(save_path, &#39;deg&#x2F;&#39;, &#39;filtered_deg.csv&#39;,sep &#x3D; &#39;&#39;)

dataframe &#x3D; read_csv(dataframe_path, col_names &#x3D; FALSE)
# colnames(dataframe) &lt;- as.character(dataframe[1, ])
dataframe &lt;- dataframe[-1, ]
# rownames(dataframe) &lt;- NULL

# 将 cluster 列中的唯一值保存到 unique_cluster 中
unique_clusters  &lt;- unique(dataframe$X6)
# 对每个唯一的 cluster 值进行循环操作

for (cluster_value  in unique_clusters ) &#123;
    # 这里执行你的操作，例如：
    # 通过 subset 函数筛选出特定 cluster 值的行
    print(cluster_value)
    subset_df &lt;- dataframe[dataframe$X6 &#x3D;&#x3D; cluster_value, ]
    
    genelist &#x3D; subset_df$X7
    genelist &#x3D; genelist[!is.na(genelist)]
    genelist &#x3D; genelist[-1]
    
    csv_result &#x3D; paste(save_path, &#39;go&#x2F;raw_results&#x2F;&#39;, cluster_value,&#39;.csv&#39;, sep &#x3D; &#39;&#39;)
    pdf_result &#x3D; paste(save_path, &#39;go&#x2F;raw_results&#x2F;&#39;, cluster_value,&#39;.pdf&#39;, sep &#x3D; &#39;&#39;)
    cal_go(genelist, pdf_result, csv_result)
&#125;


dataframe_path &#x3D; paste(save_path, &#39;deg&#x2F;&#39;, &#39;filtered_top50_deg.csv&#39;,sep &#x3D; &#39;&#39;)

dataframe &#x3D; read_csv(dataframe_path, col_names &#x3D; FALSE)
dataframe &lt;- dataframe[-1, ]
# rownames(dataframe) &lt;- NULL

# 将 cluster 列中的唯一值保存到 unique_cluster 中
unique_cluster &lt;- unique(dataframe$X6)

# 对每个唯一的 cluster 值进行循环操作
for (cluster_value in unique_cluster) &#123;
    # 这里执行你的操作，例如：
    # 通过 subset 函数筛选出特定 cluster 值的行
    subset_df &lt;- dataframe[dataframe$X6 &#x3D;&#x3D; cluster_value, ]
    genelist &#x3D; subset_df$X7
    genelist &#x3D; genelist[!is.na(genelist)]
    genelist &#x3D; genelist[-1]
    csv_result &#x3D; paste(save_path, &#39;go&#x2F;raw_results&#x2F;&#39;, cluster_value,&#39;_top50.csv&#39;, sep &#x3D; &#39;&#39;)
    pdf_result &#x3D; paste(save_path, &#39;go&#x2F;raw_results&#x2F;&#39;, cluster_value,&#39;_top50.pdf&#39;, sep &#x3D; &#39;&#39;)
    cal_go(genelist, pdf_result, csv_result)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段代码能够给一个大概的参考，有时候我们会只想要 BP
相关的数据，我们还可以读入上述生成的表格，重新进行绘制，代码如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>ticker <span class="token keyword">as</span> ticker
<span class="token keyword">import</span> os
<span class="token keyword">import</span> argparse

parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 添加命令行选项</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save_path'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Name of the gene module column'</span><span class="token punctuation">)</span>

<span class="token comment"># 解析命令行参数</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 将参数值赋给对应的变量</span>
save_path <span class="token operator">=</span> args<span class="token punctuation">.</span>save_path

csv_file_dir_path <span class="token operator">=</span> save_path <span class="token operator">+</span> <span class="token string">'go/raw_results/'</span>
save_dir_path <span class="token operator">=</span> save_path <span class="token operator">+</span> <span class="token string">'go/filtered_results/'</span>
csv_file_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>csv_file_dir_path<span class="token punctuation">)</span>
csv_file <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> csv_file_dir<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'.csv'</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>
        csv_file<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">go_bp_plot</span><span class="token punctuation">(</span>csv_file_path<span class="token punctuation">,</span> save_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    csv <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>csv_file_path<span class="token punctuation">)</span>
    csv <span class="token operator">=</span> csv<span class="token punctuation">[</span>csv<span class="token punctuation">[</span><span class="token string">'ONTOLOGY'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'BP'</span><span class="token punctuation">]</span>
    <span class="token comment"># 根据 geneID 列进行去重</span>
    <span class="token comment"># csv = csv.drop_duplicates(subset=['geneID'])</span>
    csv<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>csv<span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token comment"># 设置字体样式和大小</span>
    plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.size'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment"># 坐标轴字号为16</span>

    ax <span class="token operator">=</span> csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">.</span>barh<span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token string">'Count'</span><span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token string">'Description'</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">0.92</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'#66c2a5'</span><span class="token punctuation">)</span>

    ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Number of genes'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'12'</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'GO term'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token string">'12'</span><span class="token punctuation">)</span>

    ax<span class="token punctuation">.</span>set_yticklabels<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># Remove y-axis tick labels</span>

    <span class="token comment"># Add Description labels on top of each bar</span>
    max_v <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>csv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        Description <span class="token operator">=</span> csv<span class="token punctuation">[</span><span class="token string">'Description'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        ax<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.025</span><span class="token operator">*</span>max_v<span class="token punctuation">,</span> i<span class="token punctuation">,</span> Description<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">,</span> va<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">)</span>
    <span class="token comment"># csv['Description'][index]</span>

    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'top'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>spines<span class="token punctuation">[</span><span class="token string">'right'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># Set x-axis tick locator</span>
    ax<span class="token punctuation">.</span>xaxis<span class="token punctuation">.</span>set_major_locator<span class="token punctuation">(</span>ticker<span class="token punctuation">.</span>MaxNLocator<span class="token punctuation">(</span>integer<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Set x-axis tick formatter</span>
    ax<span class="token punctuation">.</span>xaxis<span class="token punctuation">.</span>set_major_formatter<span class="token punctuation">(</span>ticker<span class="token punctuation">.</span>FormatStrFormatter<span class="token punctuation">(</span><span class="token string">'%d'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ax<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'pdf'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    
<span class="token keyword">for</span> i <span class="token keyword">in</span> csv_file<span class="token punctuation">:</span>
    name <span class="token operator">=</span> i<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    go_bp_plot<span class="token punctuation">(</span>csv_file_dir_path <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'.csv'</span><span class="token punctuation">,</span> save_dir_path <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'.pdf'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>总体上，我们实现了空间组数据的 deg 的计算，genemodule
的计算与绘制，每个基因在各个空间注释区域的表达量的计算与 heatmap
的绘制，以及各个区域的 GO 分析。</p>
<p>最后，还有一个简易的 sh 脚本将这 6 个 python 或 R
脚本进行统一的运行，如下所示：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 所有文件的保存地址</span>
<span class="token assign-left variable">save_path</span><span class="token operator">=</span><span class="token string">"/data/gw21_scp_0103/"</span>
<span class="token comment"># 绘制 genemodule heatmap 的 h5ad path</span>
<span class="token assign-left variable">h5ad_path</span><span class="token operator">=</span><span class="token string">"/data/*_0.01.h5ad"</span>
<span class="token comment"># 求取 deg 的 rds path</span>
<span class="token assign-left variable">rds_deg_path</span><span class="token operator">=</span><span class="token string">"/data/*_0103.rds"</span>
<span class="token comment"># 求取 module 的 rds path</span>
<span class="token assign-left variable">rds_module_path</span><span class="token operator">=</span><span class="token string">"/data/*_0102.rds"</span>
<span class="token comment"># 脑区的注释信息</span>
<span class="token assign-left variable">region</span><span class="token operator">=</span><span class="token string">'Ribbon'</span>

<span class="token assign-left variable">folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">""</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">deg_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"deg/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$deg_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"deg_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$deg_folder</span>"</span>
<span class="token keyword">fi</span>


<span class="token assign-left variable">genemodules_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"genemodules/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$genemodules_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"genemodules_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$genemodules_folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">genemodules_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"genemodules/csv/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$genemodules_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"genemodules_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$genemodules_folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">genemodules_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"genemodules/fig/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$genemodules_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"genemodules_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$genemodules_folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">heatmap_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"heatmap/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$heatmap_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"genemodule_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$heatmap_folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">go_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"go/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$go_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"go_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$go_folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">go_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"go/raw_results/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$go_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"go_raw_results_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$go_folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">go_folder</span><span class="token operator">=</span><span class="token variable">$&#123;save_path&#125;</span><span class="token string">"go/filtered_results/"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$go_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"go_filtered_results_folder already exists!"</span>
<span class="token keyword">else</span>
    <span class="token function">mkdir</span> <span class="token string">"<span class="token variable">$go_folder</span>"</span>
<span class="token keyword">fi</span>

<span class="token comment"># deg 和 genemodule 计算</span>
Rscript /data/work/17.Script/addgenemodule/1.R <span class="token variable">$&#123;rds_deg_path&#125;</span> <span class="token variable">$&#123;rds_module_path&#125;</span> <span class="token variable">$&#123;region&#125;</span> <span class="token variable">$&#123;save_path&#125;</span>
<span class="token comment"># genemodule 绘制</span>
python /data/work/17.Script/addgenemodule/2.py <span class="token parameter variable">--adata_file_path</span> <span class="token variable">$&#123;h5ad_path&#125;</span> <span class="token parameter variable">--save_path</span> <span class="token variable">$&#123;save_path&#125;</span>
<span class="token comment"># heatmap 计算</span>
python /data/work/17.Script/addgenemodule/3.py <span class="token parameter variable">--adata_file_path</span> <span class="token variable">$&#123;h5ad_path&#125;</span> <span class="token parameter variable">--save_path</span> <span class="token variable">$&#123;save_path&#125;</span> <span class="token parameter variable">--cluster</span> <span class="token variable">$&#123;region&#125;</span>
<span class="token comment"># heatmap 绘制</span>
Rscript /data/work/17.Script/addgenemodule/4.R <span class="token variable">$&#123;save_path&#125;</span>
<span class="token comment"># go 求取</span>
Rscript /data/work/17.Script/addgenemodule/5.R <span class="token variable">$&#123;save_path&#125;</span>
<span class="token comment"># go 绘制</span>
python /data/work/17.Script/addgenemodule/6.py <span class="token parameter variable">--save_path</span> <span class="token variable">$&#123;save_path&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://www.zepoch.cc">zepoch</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://www.zepoch.cc/2024/397295361.html">https://www.zepoch.cc/2024/397295361.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/tech/">tech</a><a class="post-meta__tags" href="/tags/%E6%8A%80%E6%9C%AF/">技术</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css?v=1.1.3" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js?v=1.1.3" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/87416160.html" title="spatial Transcription region deg genemodule heatmap GO analysis"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">spatial Transcription region deg genemodule heatmap GO analysis</div></div></a></div><div class="next-post pull-right"><a href="/2024/4104152713.html" title="各区域不同细胞类型的统计"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">各区域不同细胞类型的统计</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/4104152713.html" title="各区域不同细胞类型的统计"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-02</div><div class="title">各区域不同细胞类型的统计</div></div></a></div><div><a href="/2024/37434737.html" title="计算某个区域中细胞的复杂性(2)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-03</div><div class="title">计算某个区域中细胞的复杂性(2)</div></div></a></div><div><a href="/2023/959813387.html" title="计算某个区域中细胞的复杂性"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-29</div><div class="title">计算某个区域中细胞的复杂性</div></div></a></div><div><a href="/2023/2669081178.html" title="Calculate the complexity of cells in a region"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-29</div><div class="title">Calculate the complexity of cells in a region</div></div></a></div><div><a href="/2024/87416160.html" title="spatial Transcription region deg genemodule heatmap GO analysis"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-03</div><div class="title">spatial Transcription region deg genemodule heatmap GO analysis</div></div></a></div><div><a href="/2024/2334324323.html" title="换一种UMAP的可视化方式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-18</div><div class="title">换一种UMAP的可视化方式</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zepoch</div><div class="author-info__description">A full-stack engineer who is improving every day</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zepoch"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zepoch" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhotoa@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/3578944600.html" title="sceasy转h5ad到rds之后基因名字消失的解决方案">sceasy转h5ad到rds之后基因名字消失的解决方案</a><time datetime="2024-05-09T08:44:12.000Z" title="Created 2024-05-09 16:44:12">2024-05-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/956785006.html" title="Transformer from 0 to 1">Transformer from 0 to 1</a><time datetime="2024-05-06T09:55:25.000Z" title="Created 2024-05-06 17:55:25">2024-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/1030812923.html" title="记录一下hexo的博客迁移（物理）">记录一下hexo的博客迁移（物理）</a><time datetime="2024-04-07T12:00:00.000Z" title="Created 2024-04-07 20:00:00">2024-04-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/2334324323.html" title="换一种UMAP的可视化方式">换一种UMAP的可视化方式</a><time datetime="2024-01-18T07:55:04.000Z" title="Created 2024-01-18 15:55:04">2024-01-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/1334308350.html" title="换一种空间组的圈细胞可视化方式">换一种空间组的圈细胞可视化方式</a><time datetime="2024-01-16T08:13:23.000Z" title="Created 2024-01-16 16:13:23">2024-01-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By zepoch</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js?v=5.0.32"></script><script src="/pluginsSrc/instant.page/instantpage.js?v=5.2.0" type="module"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js?v=17.8.5"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('/pluginsSrc/pangu/dist/browser/pangu.min.js?v=4.0.7')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'WspkUq7TuRDz5tk68Ry6TSa1-gzGzoHsz',
      appKey: 'xz4SYcXtJNP1hns8iBFAlhHT',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('/pluginsSrc/valine/dist/Valine.min.js?v=1.5.1')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !true) {
    if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div><script>
            window.imageLazyLoadSetting = {
                isSPA: true,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>